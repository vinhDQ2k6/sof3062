<!DOCTYPE html>
<html lang="vi">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Quản lý nhân viên</title>
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
		<script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
	</head>
	<body>
		<div id="app" class="container mt-4">
			<h2 class="mb-4">Quản lý nhân viên</h2>

			<!-- Form -->
			<div class="card mb-4">
				<div class="card-body">
					<form @submit.prevent="handleSubmit">
						<div class="row mb-3">
							<div class="col-md-6">
								<label class="form-label">Mã NV</label>
								<input class="form-control" type="text" v-model="form.maNV" required />
							</div>
							<div class="col-md-6">
								<label class="form-label">Họ và Tên</label>
								<input class="form-control" type="text" v-model="form.hoTen" required />
							</div>
						</div>
						<div class="row mb-3">
							<div class="col-md-6">
								<label class="form-label">Địa chỉ</label>
								<input class="form-control" type="text" v-model="form.diaChi" required />
							</div>
							<div class="col-md-6">
								<label class="form-label">Giới tính</label>
								<select class="form-select" v-model="form.gioiTinh">
									<option :value="true">Nam</option>
									<option :value="false">Nữ</option>
								</select>
							</div>
						</div>
						<button class="btn btn-primary" type="button" @click="addEmployee" :disabled="isEditing">
							Thêm
						</button>
						<button class="btn btn-warning" type="button" @click="updateEmployee" :disabled="!isEditing">
							Cập nhật
						</button>
						<button class="btn btn-secondary" type="button" @click="resetForm">Làm mới</button>
					</form>
				</div>
			</div>

			<!-- Table -->
			<table class="table table-bordered table-striped">
				<thead>
					<tr>
						<th>Mã NV</th>
						<th>Họ và Tên</th>
						<th>Địa chỉ</th>
						<th>Giới tính</th>
						<th>Hành động</th>
					</tr>
				</thead>
				<tbody>
					<tr v-for="(nv, id) in employees" :key="id">
						<td>{{ nv.maNV }}</td>
						<td>{{ nv.hoTen }}</td>
						<td>{{ nv.diaChi }}</td>
						<td>{{ nv.gioiTinh ? 'Nam' : 'Nữ' }}</td>
						<td>
							<button class="btn btn-info btn-sm me-2" @click="editEmployee(id)">Sửa</button>
							<button class="btn btn-danger btn-sm" @click="deleteEmployee(id)">Xóa</button>
						</td>
					</tr>
					<tr v-if="Object.keys(employees).length === 0">
						<td class="text-center" colspan="5">Không có dữ liệu</td>
					</tr>
				</tbody>
			</table>
		</div>

		<script>
			new Vue({
				el: "#app",
				data: {
					firebaseUrl: "",
					employees: {},
					form: {
						maNV: "",
						hoTen: "",
						diaChi: "",
						gioiTinh: true
					},
					currentId: null,
					isEditing: false
				},
				mounted() {
					this.getConfig();
				},
				methods: {
					getConfig() {
						// Fetch Firebase URL from backend
						axios
							.get("/api/nhanvien/config")
							.then((response) => {
								this.firebaseUrl = response.data.url;
								this.loadEmployees();
							})
							.catch((error) => {
								console.error("Error loading config:", error);
								alert("Không thể tải cấu hình hệ thống.");
							});
					},
					loadEmployees() {
						if (!this.firebaseUrl) return;
						axios
							.get(this.firebaseUrl + "/nhanVien.json")
							.then((response) => {
								this.employees = response.data || {};
							})
							.catch((error) => {
								console.error("Error loading employees:", error);
							});
					},
					addEmployee() {
						if (!this.firebaseUrl) return;
						// Using Axios for Create
						axios
							.post(this.firebaseUrl + "/nhanVien.json", this.form)
							.then((response) => {
								alert("Thêm thành công!");
								this.loadEmployees();
								this.resetForm();
							})
							.catch((error) => {
								console.error("Error adding employee:", error);
								alert("Lỗi khi thêm nhân viên.");
							});
					},
					updateEmployee() {
						if (!this.firebaseUrl || !this.currentId) return;
						// Using Axios for Update
						axios
							.put(this.firebaseUrl + "/nhanVien/" + this.currentId + ".json", this.form)
							.then((response) => {
								alert("Cập nhật thành công!");
								this.loadEmployees();
								this.resetForm();
							})
							.catch((error) => {
								console.error("Error updating employee:", error);
								alert("Lỗi khi cập nhật nhân viên.");
							});
					},
					editEmployee(id) {
						// Using RestTemplate (via Backend) for Edit (Fetch data)
						axios
							.get("/api/nhanvien/edit/" + id)
							.then((response) => {
								this.form = response.data;
								this.currentId = id;
								this.isEditing = true;
							})
							.catch((error) => {
								console.error("Error fetching employee details:", error);
								alert("Lỗi khi tải thông tin nhân viên.");
							});
					},
					deleteEmployee(id) {
						if (confirm("Bạn có chắc chắn muốn xóa?")) {
							// Using RestTemplate (via Backend) for Delete
							axios
								.delete("/api/nhanvien/delete/" + id)
								.then((response) => {
									alert("Xóa thành công!");
									this.loadEmployees();
								})
								.catch((error) => {
									console.error("Error deleting employee:", error);
									alert("Lỗi khi xóa nhân viên.");
								});
						}
					},
					resetForm() {
						this.form = {
							maNV: "",
							hoTen: "",
							diaChi: "",
							gioiTinh: true
						};
						this.currentId = null;
						this.isEditing = false;
					}
				}
			});
		</script>
	</body>
</html>
